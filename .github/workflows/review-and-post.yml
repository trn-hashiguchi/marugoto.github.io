name: Review diff with Gemini and post to Slack (Bot token)

on:
  push:
    branches: [ "main" ]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          # å·®åˆ†ã‚’å–ã‚‹ãŸã‚å±¥æ­´ãŒå¿…è¦
          fetch-depth: 0

      - name: Compute diff (before -> after)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # åˆå› push ç­‰ã§ BEFORE ãŒ all-zero ã®å ´åˆã¯å˜ç™ºã‚³ãƒŸãƒƒãƒˆæ‰±ã„
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" || -z "$BEFORE" ]]; then
            git show "$AFTER" --unified=3 > diff.patch
          else
            git diff "$BEFORE" "$AFTER" > diff.patch
          fi

          if [ ! -s diff.patch ]; then
            echo "empty=true" >> "$GITHUB_OUTPUT"
            echo "No diff; skipping."
          else
            echo "empty=false" >> "$GITHUB_OUTPUT"
            echo "Diff generated."
          fi

      - name: Set up Python
        if: steps.diff.outputs.empty == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (Gemini SDK + jq)
        if: steps.diff.outputs.empty == 'false'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install google-genai==0.3.0 jq

      - name: Generate review with Gemini
        if: steps.diff.outputs.empty == 'false'
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail
          python - <<'PY'
import os, textwrap
from google import genai

api_key = os.environ["GEMINI_API_KEY"]
client = genai.Client(api_key=api_key)

prompt = textwrap.dedent("""\
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®Gitã®ã‚³ãƒŸãƒƒãƒˆå·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€æ”¹å–„ç‚¹ãƒ»è‰¯ã„ç‚¹ãƒ»æ‡¸å¿µç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
å‡ºåŠ›ã¯Slackã§ç¶ºéº—ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã† **GitHub Flavored Markdown** ã§ã€
å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ `##` è¦‹å‡ºã—ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
""")

with open("diff.patch","r",encoding="utf-8") as f:
    diff = f.read()

contents = prompt + "\n```diff\n" + diff + "\n```\n"

resp = client.models.generate_content(
    model="gemini-2.0-flash-exp",
    contents=contents,
)
text = (resp.text or "(no content)")

# Slackã®é•·æ–‡ä¸Šé™ã«åˆã‚ã›è»½ããƒˆãƒªãƒ ï¼ˆç´„4ä¸‡æ–‡å­—ï¼‰
MAX = 39000
if len(text) > MAX:
    text = text[:MAX] + "\n\nâ€¦(truncated)â€¦"

with open("review.md","w",encoding="utf-8") as f:
    f.write(text)
PY

      - name: Post review text to Slack (chat.postMessage)
        if: steps.diff.outputs.empty == 'false'
        shell: bash
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          set -euo pipefail
          # review.md ã‚’ JSON æ–‡å­—åˆ—ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          TEXT=$(jq -Rs '.' < review.md)
          curl -sS -X POST 'https://slack.com/api/chat.postMessage' \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H 'Content-type: application/json; charset=utf-8' \
            --data "{\"channel\":\"${SLACK_CHANNEL_ID}\",\"text\":${TEXT}}"

      - name: Attach review.md as a file (getUploadURLExternal â†’ completeUploadExternal)
        if: steps.diff.outputs.empty == 'false'
        shell: bash
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          set -euo pipefail
          SIZE=$(wc -c < review.md)

          # Step1: ä¸€æ™‚URLã‚’å–å¾—
          UPRES=$(curl -sS -X POST 'https://slack.com/api/files.getUploadURLExternal' \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H 'Content-type: application/x-www-form-urlencoded' \
            --data "filename=review.md&length=${SIZE}")
          OK=$(echo "$UPRES" | jq -r '.ok')
          if [ "$OK" != "true" ]; then
            echo "getUploadURLExternal failed: $UPRES"
            exit 1
          fi
          UPURL=$(echo "$UPRES" | jq -r '.upload_url')
          FILEID=$(echo "$UPRES" | jq -r '.file_id')

          # Step2: å®Ÿä½“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          curl -sS -X POST "$UPURL" \
            -H 'Content-Type: application/octet-stream' \
            --data-binary @review.md >/dev/null

          # Step3: å®Œäº†é€šçŸ¥ & ãƒãƒ£ãƒ³ãƒãƒ«å…±æœ‰
          curl -sS -X POST 'https://slack.com/api/files.completeUploadExternal' \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H 'Content-type: application/json; charset=utf-8' \
            --data "{\"files\":[{\"id\":\"${FILEID}\",\"title\":\"Gemini Review\"}],\"channel_id\":\"${SLACK_CHANNEL_ID}\",\"initial_comment\":\"ğŸ“ Geminiã«ã‚ˆã‚‹ã‚³ãƒŸãƒƒãƒˆå·®åˆ†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ã€‚\"}"
